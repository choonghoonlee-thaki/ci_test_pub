name: Semgrep Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

jobs:
  semgrep:
    name: Run Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    
    # dependabot PRì€ ì œì™¸
    if: (github.actor != 'dependabot[bot]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Semgrep and generate SARIF
        run: semgrep scan --config p/ci --sarif --output=semgrep.sarif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Security íƒ­ì— SARIF ì—…ë¡œë“œ
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
      
      # PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Comment PR with Semgrep Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // SARIF íŒŒì¼ ì½ê¸°
            let sarif;
            try {
              sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8'));
            } catch (error) {
              console.log('SARIF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
              return;
            }
            
            const results = sarif.runs?.[0]?.results || [];
            
            if (results.length === 0) {
              const comment = '## âœ… Semgrep ìŠ¤ìº” ì™„ë£Œ\n\në³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              return;
            }
            
            // ì‹¬ê°ë„ë³„ë¡œ ê·¸ë£¹í™”
            const severityMap = {
              error: [],
              warning: [],
              note: []
            };
            
            results.forEach(result => {
              const level = result.level || 'note';
              const location = result.locations?.[0]?.physicalLocation;
              if (!location) return;
              
              const path = location.artifactLocation?.uri || 'unknown';
              const line = location.region?.startLine || 0;
              const message = result.message?.text || 'No message';
              const ruleId = result.ruleId || 'unknown';
              
              if (severityMap[level]) {
                severityMap[level].push({ path, line, message, ruleId });
              }
            });
            
            // ì½”ë©˜íŠ¸ ìƒì„±
            let comment = '## ğŸ” Semgrep ìŠ¤ìº” ê²°ê³¼\n\n';
            comment += `ì´ **${results.length}ê°œ**ì˜ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
            
            const addSection = (title, emoji, items) => {
              if (items.length > 0) {
                comment += `### ${emoji} ${title} (${items.length})\n\n`;
                items.slice(0, 5).forEach(item => {
                  comment += `- **${item.ruleId}**\n`;
                  comment += `  - ğŸ“ \`${item.path}:${item.line}\`\n`;
                  comment += `  - ğŸ’¬ ${item.message}\n\n`;
                });
              }
            };
            
            addSection('Error', 'ğŸ”´', severityMap.error);
            addSection('Warning', 'ğŸŸ¡', severityMap.warning);
            addSection('Note', 'â„¹ï¸', severityMap.note);
            
            comment += '\n---\n';
            comment += `ìì„¸í•œ ë‚´ìš©ì€ [Security íƒ­](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });