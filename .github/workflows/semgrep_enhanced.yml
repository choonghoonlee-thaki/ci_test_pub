name: Semgrep Security Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

jobs:
  semgrep:
    name: Run Semgrep Security Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    
    if: (github.actor != 'dependabot[bot]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Semgrep Security Audit
        run: |
          semgrep scan \
            --config p/security-audit \
            --sarif \
            --output=semgrep.sarif \
            --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
      
      - name: Enhanced PR Comment with Code Snippets
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // PR ìš”ì•½ ì½”ë©˜íŠ¸ (Conversation íƒ­)ì™€ ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ (Files changed íƒ­) ëª¨ë‘ ìƒì„±
            const fs = require('fs');
            
            // SARIF íŒŒì¼ ì½ê¸°
            let sarif;
            try {
              sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8'));
            } catch (error) {
              console.log('SARIF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
              return;
            }
            
            const results = sarif.runs?.[0]?.results || [];
            const rules = sarif.runs?.[0]?.tool?.driver?.rules || [];
            
            if (results.length === 0) {
              const comment = '## âœ… Semgrep ìŠ¤ìº” ì™„ë£Œ\n\në³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              return;
            }
            
            // ê·œì¹™ ì •ë³´ë¥¼ Mapìœ¼ë¡œ êµ¬ì„±
            const ruleMap = new Map();
            rules.forEach(rule => {
              ruleMap.set(rule.id, rule);
            });
            
            // ì‹¬ê°ë„ë³„ë¡œ ê·¸ë£¹í™”
            const severityMap = {
              critical: { emoji: 'ğŸ”´', label: 'Critical', items: [] },
              high: { emoji: 'ğŸŸ ', label: 'High', items: [] },
              medium: { emoji: 'ğŸŸ¡', label: 'Medium', items: [] },
              low: { emoji: 'ğŸŸ¢', label: 'Low', items: [] },
              info: { emoji: 'â„¹ï¸', label: 'Info', items: [] }
            };
            
            // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ Set
            const seenIssues = new Set();
            
            results.forEach(result => {
              const location = result.locations?.[0]?.physicalLocation;
              if (!location) return;
              
              const ruleId = result.ruleId || 'unknown';
              const path = location.artifactLocation?.uri || 'unknown';
              const startLine = location.region?.startLine || 0;
              const endLine = location.region?.endLine || startLine;
              
              // ì¤‘ë³µ ì²´í¬ (ê°™ì€ íŒŒì¼, ê°™ì€ ë¼ì¸, ê°™ì€ ê·œì¹™ì€ ìŠ¤í‚µ)
              const issueKey = `${ruleId}:${path}:${startLine}`;
              if (seenIssues.has(issueKey)) {
                return;
              }
              seenIssues.add(issueKey);
              
              const message = result.message?.text || 'No message';
              const snippet = location.region?.snippet?.text || '';
              
              // ê·œì¹™ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              const rule = ruleMap.get(ruleId);
              const ruleDescription = rule?.shortDescription?.text || 
                                     rule?.fullDescription?.text || 
                                     message;
              
              // ì‹¬ê°ë„ ê²°ì • (ìš°ì„ ìˆœìœ„: level > properties.security-severity > defaultConfiguration.level)
              let severity = 'info';
              
              // 1. result.level í™•ì¸
              const level = result.level?.toLowerCase();
              if (level === 'error') {
                severity = 'critical';
              } else if (level === 'warning') {
                severity = 'medium';
              } else if (level === 'note') {
                severity = 'low';
              }
              
              // 2. ruleì˜ security-severity í™•ì¸ (ë” ì •í™•í•¨)
              if (rule?.properties?.['security-severity']) {
                const secSeverity = rule.properties['security-severity'];
                if (typeof secSeverity === 'string') {
                  severity = secSeverity.toLowerCase();
                } else if (typeof secSeverity === 'number') {
                  // CVSS ì ìˆ˜ ê¸°ë°˜ ë³€í™˜
                  if (secSeverity >= 9.0) severity = 'critical';
                  else if (secSeverity >= 7.0) severity = 'high';
                  else if (secSeverity >= 4.0) severity = 'medium';
                  else if (secSeverity >= 0.1) severity = 'low';
                  else severity = 'info';
                }
              }
              
              // 3. ruleì˜ defaultConfiguration.level í™•ì¸
              if (!severity || severity === 'info') {
                const defaultLevel = rule?.defaultConfiguration?.level?.toLowerCase();
                if (defaultLevel === 'error') severity = 'critical';
                else if (defaultLevel === 'warning') severity = 'medium';
                else if (defaultLevel === 'note') severity = 'low';
              }
              
              // 4. ê·œì¹™ ì´ë¦„ìœ¼ë¡œ ì¶”ë¡  (fallback)
              if (severity === 'info') {
                const lowerRuleId = ruleId.toLowerCase();
                if (lowerRuleId.includes('injection') || 
                    lowerRuleId.includes('deserialization') ||
                    lowerRuleId.includes('sql') ||
                    lowerRuleId.includes('command')) {
                  severity = 'critical';
                } else if (lowerRuleId.includes('security')) {
                  severity = 'high';
                }
              }
              
              // ì‹¬ê°ë„ê°€ ì—†ìœ¼ë©´ infoë¡œ ì²˜ë¦¬
              if (!severityMap[severity]) {
                severity = 'info';
              }
              
              severityMap[severity].items.push({
                path,
                startLine,
                endLine,
                message,
                ruleId,
                snippet,
                description: ruleDescription,
                severity
              });
            });
            
            // í†µê³„ ê³„ì‚°
            const totalCritical = severityMap.critical.items.length;
            const totalHigh = severityMap.high.items.length;
            const totalMedium = severityMap.medium.items.length;
            const totalLow = severityMap.low.items.length;
            const totalInfo = severityMap.info.items.length;
            const total = totalCritical + totalHigh + totalMedium + totalLow + totalInfo;
            
            // Summary ì½”ë©˜íŠ¸ ìƒì„± (ìƒì„¸ ë‚´ìš© ì œì™¸)
            let comment = '## ğŸ” Semgrep Security Scan Results\n\n';
            comment += '### ğŸ“Š Summary\n\n';
            comment += '| Severity | Count |\n';
            comment += '|----------|-------|\n';
            comment += `| ğŸ”´ **Critical** | **${totalCritical}** |\n`;
            comment += `| ğŸŸ  **High** | **${totalHigh}** |\n`;
            comment += `| ğŸŸ¡ Medium | ${totalMedium} |\n`;
            comment += `| ğŸŸ¢ Low | ${totalLow} |\n`;
            comment += `| â„¹ï¸ Info | ${totalInfo} |\n`;
            comment += `| **Total** | **${total}** |\n\n`;
            
            if (totalCritical > 0 || totalHigh > 0) {
              comment += '> âš ï¸ **Action Required**: Critical or High severity issues found. Please review and fix them before merging.\n\n';
            } else if (total > 0) {
              comment += '> â„¹ï¸ Issues found. Please review the details below.\n\n';
            }
            
            comment += '---\n\n';
            comment += '### ğŸ“ Detailed Findings\n\n';
            comment += '**All security findings are available as inline review comments in the "Files changed" tab.**\n\n';
            comment += 'Each issue includes:\n';
            comment += '- ğŸ¯ Exact location in your code\n';
            comment += '- ğŸ“– Detailed explanation of the vulnerability\n';
            comment += '- ğŸ’¡ Recommendations for fixing\n';
            comment += '- ğŸ”— Links to documentation\n\n';
            comment += 'ğŸ‘‰ **[Go to Files changed tab to see all inline comments](';
            comment += `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}/files)**\n\n`;
            comment += '---\n\n';
            comment += '### ğŸ“š Additional Resources\n\n';
            comment += `- [View all findings in Security tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)\n`;
            comment += `- [Semgrep Rule Documentation](https://semgrep.dev/r)\n`;
            comment += `- [Semgrep Playground](https://semgrep.dev/playground) - Test rules interactively\n`;
            comment += '\n> ğŸ’¡ **Tip**: Click "Resolve conversation" on each inline comment after fixing the issue.\n';
            
            // ì½”ë©˜íŠ¸ ê¸¸ì´ ì œí•œ
            if (comment.length > 65000) {
              comment = comment.substring(0, 65000) + '\n\n... (truncated due to length)';
            }
            
            // 1. PR ìš”ì•½ ì½”ë©˜íŠ¸ ìƒì„± (Conversation íƒ­)
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            // 2. ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ ìƒì„± (Files changed íƒ­ì— Reply ë²„íŠ¼ í¬í•¨)
            // Critical/High ì´ìŠˆë§Œ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¡œ ì¶”ê°€
            const criticalAndHighIssues = [
              ...severityMap.critical.items,
              ...severityMap.high.items
            ];
            
            if (criticalAndHighIssues.length > 0) {
              // PRì˜ HEAD SHA ê°€ì ¸ì˜¤ê¸°
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              
              const headSha = pr.data.head.sha;
              
              // Review ìƒì„± (ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¥¼ ê·¸ë£¹í™”)
              const reviewComments = criticalAndHighIssues.slice(0, 10).map(item => {
              // ë“±ê¸‰ë³„ ì´ëª¨ì§€ì™€ í…ìŠ¤íŠ¸ ë§¤í•‘
                const severityMap = {
                  'critical': { emoji: 'ğŸ”´', text: 'Critical' },
                  'high':     { emoji: 'ğŸŸ ', text: 'High' },
                  'medium':   { emoji: 'ğŸŸ¡', text: 'Medium' },
                  'low':      { emoji: 'ğŸŸ¢', text: 'Low' },
                  'info':     { emoji: 'â„¹ï¸', text: 'Info' }
                };

                // ë§¤í•‘ ì •ë³´ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ê°’ ì„¤ì •
                const { emoji, text } = severityMap[item.severity.toLowerCase()] || { emoji: 'âšª', text: item.severity };

                let body = `## ${emoji} ${text}: ${item.ruleId}\n\n`;
              
              
                body += `**${item.description}**\n\n`;
                body += `ğŸ’¬ ${item.message}\n\n`;
                body += `[Learn more about this rule](https://semgrep.dev/r/${item.ruleId})`;
                
                return {
                  path: item.path,
                  line: item.startLine,
                  body: body
                };
              });
              
              try {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  commit_id: headSha,
                  event: 'COMMENT',
                  comments: reviewComments
                });
              } catch (error) {
                console.log('ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ ìƒì„± ì‹¤íŒ¨:', error.message);
                // ì‹¤íŒ¨í•´ë„ ìš”ì•½ ì½”ë©˜íŠ¸ëŠ” ì´ë¯¸ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
              }
            }