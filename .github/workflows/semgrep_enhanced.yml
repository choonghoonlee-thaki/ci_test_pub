name: Semgrep Enhanced Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

jobs:
  semgrep:
    name: Run Semgrep Enhanced
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    
    if: (github.actor != 'dependabot[bot]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Semgrep with multiple rulesets
        run: |
          semgrep scan \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --config p/ci \
            --sarif \
            --output=semgrep.sarif \
            --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Pro ê¸°ëŠ¥ ì‚¬ìš©ì‹œ ì¶”ê°€ (ì„ íƒì‚¬í•­)
          # SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
      
      - name: Enhanced PR Comment with Code Snippets
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // SARIF íŒŒì¼ ì½ê¸°
            let sarif;
            try {
              sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8'));
            } catch (error) {
              console.log('SARIF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
              return;
            }
            
            const results = sarif.runs?.[0]?.results || [];
            
            if (results.length === 0) {
              const comment = '## âœ… Semgrep ìŠ¤ìº” ì™„ë£Œ\n\në³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              return;
            }
            
            // ì‹¬ê°ë„ë³„ë¡œ ê·¸ë£¹í™” ë° ë°ì´í„° ìˆ˜ì§‘
            const severityMap = {
              error: { emoji: 'ðŸ”´', label: 'Critical/High', items: [] },
              warning: { emoji: 'ðŸŸ¡', label: 'Medium', items: [] },
              note: { emoji: 'â„¹ï¸', label: 'Low/Info', items: [] }
            };
            
            results.forEach(result => {
              const level = result.level || 'note';
              const location = result.locations?.[0]?.physicalLocation;
              if (!location) return;
              
              const path = location.artifactLocation?.uri || 'unknown';
              const startLine = location.region?.startLine || 0;
              const endLine = location.region?.endLine || startLine;
              const message = result.message?.text || 'No message';
              const ruleId = result.ruleId || 'unknown';
              
              // ì½”ë“œ ìŠ¤ë‹ˆíŽ« ì¶”ì¶œ
              const snippet = location.region?.snippet?.text || '';
              
              // ê·œì¹™ ìƒì„¸ ì •ë³´
              const rule = sarif.runs[0].tool.driver.rules?.find(r => r.id === ruleId);
              const severity = rule?.properties?.['security-severity'] || 
                              rule?.defaultConfiguration?.level || level;
              const description = rule?.shortDescription?.text || 
                                 rule?.fullDescription?.text || message;
              
              if (severityMap[level]) {
                severityMap[level].items.push({
                  path,
                  startLine,
                  endLine,
                  message,
                  ruleId,
                  snippet,
                  description,
                  severity
                });
              }
            });
            
            // í†µê³„ ê³„ì‚°
            const totalCritical = severityMap.error.items.length;
            const totalMedium = severityMap.warning.items.length;
            const totalLow = severityMap.note.items.length;
            const total = totalCritical + totalMedium + totalLow;
            
            // ì½”ë©˜íŠ¸ í—¤ë” ìƒì„±
            let comment = '## ðŸ” Semgrep Security Scan Results\n\n';
            comment += '### ðŸ“Š Summary\n\n';
            comment += '| Severity | Count |\n';
            comment += '|----------|-------|\n';
            comment += `| ðŸ”´ **Critical/High** | **${totalCritical}** |\n`;
            comment += `| ðŸŸ¡ Medium | ${totalMedium} |\n`;
            comment += `| â„¹ï¸ Low/Info | ${totalLow} |\n`;
            comment += `| **Total** | **${total}** |\n\n`;
            comment += '---\n\n';
            
            // ê° ì‹¬ê°ë„ë³„ ìƒì„¸ ë‚´ìš© ì¶”ê°€
            const addDetailedSection = (level, data) => {
              if (data.items.length === 0) return;
              
              comment += `### ${data.emoji} ${data.label} Issues (${data.items.length})\n\n`;
              
              // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ í‘œì‹œ (ë„ˆë¬´ ê¸¸ì–´ì§€ëŠ” ê²ƒ ë°©ì§€)
              const itemsToShow = data.items.slice(0, 10);
              
              itemsToShow.forEach((item, index) => {
                comment += `#### ${index + 1}. ${item.ruleId}\n\n`;
                comment += `**${item.description}**\n\n`;
                comment += `ðŸ“ \`${item.path}\` (Line ${item.startLine}`;
                if (item.endLine !== item.startLine) {
                  comment += `-${item.endLine}`;
                }
                comment += ')\n\n';
                
                // ì½”ë“œ ìŠ¤ë‹ˆíŽ« ì¶”ê°€
                if (item.snippet) {
                  comment += '```python\n';
                  comment += item.snippet.trim();
                  comment += '\n```\n\n';
                }
                
                comment += `ðŸ’¬ ${item.message}\n\n`;
                comment += '---\n\n';
              });
              
              if (data.items.length > 10) {
                comment += `*... and ${data.items.length - 10} more ${data.label.toLowerCase()} issues*\n\n`;
              }
            };
            
            // Criticalë¶€í„° ìˆœì„œëŒ€ë¡œ ì¶”ê°€
            addDetailedSection('error', severityMap.error);
            addDetailedSection('warning', severityMap.warning);
            addDetailedSection('note', severityMap.note);
            
            // í‘¸í„° ì¶”ê°€
            comment += '\n### ðŸ“š Additional Resources\n\n';
            comment += `- [View all findings in Security tab](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning)\n`;
            comment += `- [Semgrep Rule Documentation](https://semgrep.dev/r)\n`;
            comment += '\n> ðŸ’¡ **Tip**: Click on rule IDs to learn more about each vulnerability and how to fix it.\n';
            
            // ì½”ë©˜íŠ¸ê°€ ë„ˆë¬´ ê¸¸ë©´ GitHub API ì œí•œì— ê±¸ë¦´ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ í™•ì¸
            if (comment.length > 65000) {
              comment = comment.substring(0, 65000) + '\n\n... (truncated due to length)';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });