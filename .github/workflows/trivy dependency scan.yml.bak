name: trivy dependency scan
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-scan:
    name: Trivy Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          format: json
          output: trivy-results.json
          exit-code: 0
          severity: CRITICAL,HIGH
      
      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH
      
      - name: Comment PR with Trivy Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // JSON íŒŒì¼ ì½ê¸°
            let trivyResults;
            try {
              trivyResults = JSON.parse(fs.readFileSync('trivy-results.json', 'utf8'));
            } catch (error) {
              console.log('Trivy ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
              return;
            }
            
            // ì·¨ì•½ì  ìˆ˜ì§‘
            const vulnerabilities = {
              CRITICAL: [],
              HIGH: []
            };
            
            let totalVulns = 0;
            
            if (trivyResults.Results) {
              trivyResults.Results.forEach(result => {
                if (result.Vulnerabilities) {
                  result.Vulnerabilities.forEach(vuln => {
                    const severity = vuln.Severity;
                    if (severity === 'CRITICAL' || severity === 'HIGH') {
                      vulnerabilities[severity].push({
                        target: result.Target,
                        id: vuln.VulnerabilityID,
                        pkg: vuln.PkgName,
                        version: vuln.InstalledVersion,
                        fixed: vuln.FixedVersion || 'N/A',
                        title: vuln.Title || vuln.Description || 'No description'
                      });
                      totalVulns++;
                    }
                  });
                }
              });
            }
            
            // ì·¨ì•½ì ì´ ì—†ëŠ” ê²½ìš°
            if (totalVulns === 0) {
              const comment = '## âœ… Trivy ì˜ì¡´ì„± ìŠ¤ìº” ì™„ë£Œ\n\nì‹¬ê°í•œ ì·¨ì•½ì (CRITICAL/HIGH)ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              return;
            }
            
            // ì½”ë©˜íŠ¸ ìƒì„±
            let comment = '## ğŸ” Trivy ì˜ì¡´ì„± ìŠ¤ìº” ê²°ê³¼\n\n';
            comment += `ì´ **${totalVulns}ê°œ**ì˜ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
            
            // CRITICAL ì·¨ì•½ì 
            if (vulnerabilities.CRITICAL.length > 0) {
              comment += `### ğŸ”´ CRITICAL (${vulnerabilities.CRITICAL.length})\n\n`;
              vulnerabilities.CRITICAL.forEach(vuln => {
                comment += `- **${vuln.id}** - ${vuln.pkg}\n`;
                comment += `  - ğŸ“¦ Target: \`${vuln.target}\`\n`;
                comment += `  - ğŸ“Œ Installed: \`${vuln.version}\` â†’ Fixed: \`${vuln.fixed}\`\n`;
                comment += `  - ğŸ’¬ ${vuln.title}\n\n`;
              });
            }
            
            // HIGH ì·¨ì•½ì 
            if (vulnerabilities.HIGH.length > 0) {
              comment += `### ğŸŸ¡ HIGH (${vulnerabilities.HIGH.length})\n\n`;
              vulnerabilities.HIGH.forEach(vuln => {
                comment += `- **${vuln.id}** - ${vuln.pkg}\n`;
                comment += `  - ğŸ“¦ Target: \`${vuln.target}\`\n`;
                comment += `  - ğŸ“Œ Installed: \`${vuln.version}\` â†’ Fixed: \`${vuln.fixed}\`\n`;
                comment += `  - ğŸ’¬ ${vuln.title}\n\n`;
              });
            }
            
            comment += '\n---\n';
            comment += 'âš ï¸ ì·¨ì•½ì ì„ ìˆ˜ì •í•˜ë ¤ë©´ íŒ¨í‚¤ì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });