name: Semgrep Scan

on:
  pull_request:
  push:
    branches:

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

jobs:
  semgrep:
    name: Run Semgrep
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Run Semgrep
        id: semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: "p/ci"
          generateSarif: true
        env:
          # PRì— ìë™ìœ¼ë¡œ ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ê¸° ìœ„í•´ í•„ìš”
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Security íƒ­ì— SARIF ì—…ë¡œë“œ
      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif
      
      # PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Comment PR with Semgrep Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // SARIF íŒŒì¼ ì½ê¸°
            let sarif;
            try {
              sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8'));
            } catch (error) {
              console.log('SARIF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            const results = sarif.runs[0].results || [];
            
            if (results.length === 0) {
              const comment = '## âœ… Semgrep ìŠ¤ìº” ì™„ë£Œ\n\në³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              return;
            }
            
            // ì‹¬ê°ë„ë³„ë¡œ ê·¸ë£¹í™”
            const severityMap = {
              error: [],
              warning: [],
              note: []
            };
            
            results.forEach(result => {
              const level = result.level || 'note';
              const location = result.locations[0].physicalLocation;
              const path = location.artifactLocation.uri;
              const line = location.region.startLine;
              const message = result.message.text;
              const ruleId = result.ruleId;
              
              severityMap[level].push({
                path,
                line,
                message,
                ruleId
              });
            });
            
            // ì½”ë©˜íŠ¸ ìƒì„±
            let comment = '## ğŸ” Semgrep ìŠ¤ìº” ê²°ê³¼\n\n';
            comment += `ì´ **${results.length}ê°œ**ì˜ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
            
            if (severityMap.error.length > 0) {
              comment += `### ğŸ”´ Error (${severityMap.error.length})\n\n`;
              severityMap.error.forEach(item => {
                comment += `- **${item.ruleId}**\n`;
                comment += `  - íŒŒì¼: \`${item.path}:${item.line}\`\n`;
                comment += `  - ë‚´ìš©: ${item.message}\n\n`;
              });
            }
            
            if (severityMap.warning.length > 0) {
              comment += `### ğŸŸ¡ Warning (${severityMap.warning.length})\n\n`;
              severityMap.warning.forEach(item => {
                comment += `- **${item.ruleId}**\n`;
                comment += `  - íŒŒì¼: \`${item.path}:${item.line}\`\n`;
                comment += `  - ë‚´ìš©: ${item.message}\n\n`;
              });
            }
            
            if (severityMap.note.length > 0) {
              comment += `### â„¹ï¸ Note (${severityMap.note.length})\n\n`;
              severityMap.note.forEach(item => {
                comment += `- **${item.ruleId}**\n`;
                comment += `  - íŒŒì¼: \`${item.path}:${item.line}\`\n`;
                comment += `  - ë‚´ìš©: ${item.message}\n\n`;
              });
            }
            
            comment += '\n---\nìì„¸í•œ ë‚´ìš©ì€ [Security íƒ­](/${{ github.repository }}/security/code-scanning)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });