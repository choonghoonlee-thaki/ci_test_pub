name: Trivy Dependency Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-scan:
    name: Trivy Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # PRì¸ ê²½ìš°: ì˜ì¡´ì„± íŒŒì¼ ë³€ê²½ ì—¬ë¶€ í™•ì¸
      - name: Check dependency file changes (PR only)
        id: dep-check
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prFiles = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 100
            });
            
            // ì˜ì¡´ì„± íŒŒì¼ ëª©ë¡
            const depFilePatterns = [
              // JavaScript/Node.js
              'package.json', 'package-lock.json', 'yarn.lock', 'pnpm-lock.yaml',
              // Python
              'requirements.txt', 'Pipfile', 'Pipfile.lock', 'poetry.lock', 'setup.py', 'pyproject.toml',
              // Java/Kotlin
              'pom.xml', 'build.gradle', 'build.gradle.kts', 'gradle.lockfile',
              // Go
              'go.mod', 'go.sum',
              // Ruby
              'Gemfile', 'Gemfile.lock',
              // .NET
              'packages.config', '*.csproj', '*.fsproj',
              // Rust
              'Cargo.toml', 'Cargo.lock',
              // PHP
              'composer.json', 'composer.lock'
            ];
            
            const changedDepFiles = prFiles.data.filter(file => {
              const filename = file.filename.split('/').pop(); // íŒŒì¼ëª…ë§Œ ì¶”ì¶œ
              return depFilePatterns.some(pattern => {
                if (pattern.includes('*')) {
                  // ì™€ì¼ë“œì¹´ë“œ íŒ¨í„´
                  const regex = new RegExp(pattern.replace('*', '.*'));
                  return regex.test(filename);
                }
                return filename === pattern;
              });
            });
            
            if (changedDepFiles.length > 0) {
              console.log('ë³€ê²½ëœ ì˜ì¡´ì„± íŒŒì¼:', changedDepFiles.map(f => f.filename));
              core.setOutput('has_changes', 'true');
              core.setOutput('changed_files', changedDepFiles.map(f => f.filename).join(', '));
            } else {
              console.log('ì˜ì¡´ì„± íŒŒì¼ ë³€ê²½ ì—†ìŒ - ìŠ¤ìº” ìŠ¤í‚µ');
              core.setOutput('has_changes', 'false');
              core.setOutput('changed_files', '');
            }
      
      # Pushì¸ ê²½ìš° ë˜ëŠ” PRì—ì„œ ì˜ì¡´ì„± íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ìŠ¤ìº”
      - name: Run Trivy vulnerability scanner (JSON)
        if: github.event_name == 'push' || steps.dep-check.outputs.has_changes == 'true'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          format: json
          output: trivy-results.json
          exit-code: 0
          severity: CRITICAL,HIGH,MEDIUM
      
      - name: Run Trivy vulnerability scanner (Table - for logs)
        if: github.event_name == 'push' || steps.dep-check.outputs.has_changes == 'true'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH,MEDIUM
      
      # PR ì½”ë©˜íŠ¸: ì˜ì¡´ì„± íŒŒì¼ ë³€ê²½ ì—†ëŠ” ê²½ìš°
      - name: Comment PR (No dependency changes)
        if: github.event_name == 'pull_request' && steps.dep-check.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## âœ… Trivy ì˜ì¡´ì„± ìŠ¤ìº”\n\nì´ PRì—ì„œ ì˜ì¡´ì„± íŒŒì¼ ë³€ê²½ì´ ê°ì§€ë˜ì§€ ì•Šì•„ ìŠ¤ìº”ì„ ìŠ¤í‚µí–ˆìŠµë‹ˆë‹¤.\n\n> ğŸ“Œ ì˜ì¡´ì„± íŒŒì¼: `package.json`, `pom.xml`, `requirements.txt` ë“±'
            });
      
      # PR ì½”ë©˜íŠ¸: ìŠ¤ìº” ê²°ê³¼
      - name: Comment PR with Trivy Results
        if: github.event_name == 'pull_request' && steps.dep-check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // JSON íŒŒì¼ ì½ê¸°
            let trivyResults;
            try {
              trivyResults = JSON.parse(fs.readFileSync('trivy-results.json', 'utf8'));
            } catch (error) {
              console.log('Trivy ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
              return;
            }
            
            // ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
            const changedFiles = '${{ steps.dep-check.outputs.changed_files }}';
            
            // ì·¨ì•½ì  ìˆ˜ì§‘
            const vulnerabilities = {
              CRITICAL: [],
              HIGH: [],
              MEDIUM: []
            };
            
            let totalVulns = 0;
            
            if (trivyResults.Results) {
              trivyResults.Results.forEach(result => {
                if (result.Vulnerabilities) {
                  result.Vulnerabilities.forEach(vuln => {
                    const severity = vuln.Severity;
                    if (vulnerabilities[severity]) {
                      vulnerabilities[severity].push({
                        target: result.Target,
                        id: vuln.VulnerabilityID,
                        pkg: vuln.PkgName,
                        version: vuln.InstalledVersion,
                        fixed: vuln.FixedVersion || 'N/A',
                        title: vuln.Title || vuln.Description || 'No description'
                      });
                      totalVulns++;
                    }
                  });
                }
              });
            }
            
            // ì·¨ì•½ì ì´ ì—†ëŠ” ê²½ìš°
            if (totalVulns === 0) {
              let comment = '## âœ… Trivy ì˜ì¡´ì„± ìŠ¤ìº” ì™„ë£Œ\n\n';
              comment += 'ì‹¬ê°í•œ ì·¨ì•½ì (CRITICAL/HIGH/MEDIUM)ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n';
              comment += `> ğŸ“¦ ìŠ¤ìº”ëœ ì˜ì¡´ì„± íŒŒì¼: \`${changedFiles}\``;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              return;
            }
            
            // ì½”ë©˜íŠ¸ ìƒì„±
            let comment = '## ğŸ” Trivy ì˜ì¡´ì„± ìŠ¤ìº” ê²°ê³¼\n\n';
            comment += `> ğŸ“¦ ë³€ê²½ëœ ì˜ì¡´ì„± íŒŒì¼: \`${changedFiles}\`\n\n`;
            comment += `ì´ **${totalVulns}ê°œ**ì˜ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;
            
            // Summary í…Œì´ë¸”
            comment += '### ğŸ“Š Summary\n\n';
            comment += '| Severity | Count |\n';
            comment += '|----------|-------|\n';
            comment += `| ğŸ”´ **CRITICAL** | **${vulnerabilities.CRITICAL.length}** |\n`;
            comment += `| ğŸŸ  **HIGH** | **${vulnerabilities.HIGH.length}** |\n`;
            comment += `| ğŸŸ¡ MEDIUM | ${vulnerabilities.MEDIUM.length} |\n\n`;
            
            // CRITICAL ì·¨ì•½ì 
            if (vulnerabilities.CRITICAL.length > 0) {
              comment += `### ğŸ”´ CRITICAL (${vulnerabilities.CRITICAL.length})\n\n`;
              comment += '| Source | Package | Vulnerability | Installed | Fixed | Description |\n';
              comment += '|--------|---------|---------------|-----------|-------|-------------|\n';
              vulnerabilities.CRITICAL.forEach(vuln => {
                const title = vuln.title.length > 40 ? vuln.title.substring(0, 40) + '...' : vuln.title;
                const source = vuln.target.split('/').pop(); // íŒŒì¼ëª…ë§Œ ì¶”ì¶œ
                comment += `| \`${source}\` | \`${vuln.pkg}\` | [${vuln.id}](https://nvd.nist.gov/vuln/detail/${vuln.id}) | ${vuln.version} | ${vuln.fixed} | ${title} |\n`;
              });
              comment += '\n';
            }
            
            // HIGH ì·¨ì•½ì 
            if (vulnerabilities.HIGH.length > 0) {
              comment += `### ğŸŸ  HIGH (${vulnerabilities.HIGH.length})\n\n`;
              comment += '| Source | Package | Vulnerability | Installed | Fixed | Description |\n';
              comment += '|--------|---------|---------------|-----------|-------|-------------|\n';
              vulnerabilities.HIGH.forEach(vuln => {
                const title = vuln.title.length > 40 ? vuln.title.substring(0, 40) + '...' : vuln.title;
                const source = vuln.target.split('/').pop();
                comment += `| \`${source}\` | \`${vuln.pkg}\` | [${vuln.id}](https://nvd.nist.gov/vuln/detail/${vuln.id}) | ${vuln.version} | ${vuln.fixed} | ${title} |\n`;
              });
              comment += '\n';
            }
            
            // MEDIUM ì·¨ì•½ì 
            if (vulnerabilities.MEDIUM.length > 0) {
              comment += `### ğŸŸ¡ MEDIUM (${vulnerabilities.MEDIUM.length})\n\n`;
              comment += '| Source | Package | Vulnerability | Installed | Fixed | Description |\n';
              comment += '|--------|---------|---------------|-----------|-------|-------------|\n';
              vulnerabilities.MEDIUM.forEach(vuln => {
                const title = vuln.title.length > 40 ? vuln.title.substring(0, 40) + '...' : vuln.title;
                const source = vuln.target.split('/').pop();
                comment += `| \`${source}\` | \`${vuln.pkg}\` | [${vuln.id}](https://nvd.nist.gov/vuln/detail/${vuln.id}) | ${vuln.version} | ${vuln.fixed} | ${title} |\n`;
              });
              comment += '\n';
            }
            
            comment += '---\n\n';
            comment += '### ğŸ’¡ í•´ê²° ë°©ë²•\n\n';
            comment += 'ì·¨ì•½ì ì„ ìˆ˜ì •í•˜ë ¤ë©´ íŒ¨í‚¤ì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”:\n\n';
            comment += '```bash\n';
            comment += '# npm\n';
            comment += 'npm update <package-name>\n\n';
            comment += '# pip\n';
            comment += 'pip install --upgrade <package-name>\n\n';
            comment += '# maven\n';
            comment += 'mvn versions:use-latest-versions\n';
            comment += '```\n';
            
            // ì½”ë©˜íŠ¸ ê¸¸ì´ ì œí•œ
            if (comment.length > 65000) {
              comment = comment.substring(0, 65000) + '\n\n... (truncated)';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
